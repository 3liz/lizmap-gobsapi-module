
<!DOCTYPE HTML>
<html>
 <head>
  <meta charset="utf-8"/>
  <title>G-Obs API configuration</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.1/styles/github.min.css" rel="stylesheet"/>
  <link href="https://docs.3liz.org/remarkable.css" rel="stylesheet"/>
  <link href="icon.png" rel="icon" type="image/png" >
 </head>
 <body>
 <header class="header-container" style="">
    <h1>G-Obs API configuration</h1>
 </header>
 <article>

<div class="toc"><span class="toctitle">Table of content</span><ul>
<li><a href="#configuration">Configuration</a><ul>
<li><a href="#project">Project</a></li>
<li><a href="#indicators">Indicators</a><ul>
<li><a href="#documents">Documents</a></li>
</ul>
</li>
<li><a href="#observations">Observations</a><ul>
<li><a href="#media">Media</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<h1 id="configuration">Configuration</h1>
<p>The G-Obs <strong>API module</strong> is tightly linked to the <strong>G-Obs QGIS plugin</strong>, and to the use of Lizmap Web Client as the web map publication tool.</p>
<p>We write here some help regarding the specific configuration needed for G-Obs API. A full documentation on Lizmap Web Client is available here: <a href="https://docs.lizmap.com/">https://docs.lizmap.com/</a></p>
<h2 id="project">Project</h2>
<p>A project in G-Obs corresponds to a QGIS project published to Lizmap, with some specificities:</p>
<ul>
<li><strong>Indicators</strong>: In the QGIS Project properties, you need to have a <strong>project variable</strong> <code>gobs_indicators</code> containing the list of indicators that you want to publish in the project. To do so, open the project properties (CTRL+MAJ+P), go to the <code>Variables</code> tab, and add a new variable: name <code>gobs_indicators</code> and value containing the list of indicator <strong>codes</strong> separated by comma. For example: <code>pluviometry,population</code> will "publish" these two indicators (pluviometry and population) with the QGIS project.</li>
<li><strong>Connection name</strong>: You must also add another QGIS <strong>project variable</strong> <code>gobs_connection_name</code> containing the name of the PostgreSQL connection name (as written in the QGIS connection configuration dialog). This connection name must be <strong>exactly the same</strong> as the name of the <strong>PostgreSQL service</strong> which is used locally (your computer) and in the <strong>GobsAPI server</strong>.</li>
<li><strong>Additional spatial data</strong>: you can also publish a <strong>Geopackage file</strong> alongside the project, to be used by any software to display referential spatial layers on the map with the observation data. To do so, just create and save a Geopackage file containing vector layers (and raster layers if needed) named as the QGIS project. For example, if you project file is <code>my_gobs_project.qgs</code>, you must save the Geopackage file in the same folder with the name <code>my_gobs_project.qgs.gpkg</code>. You can create and populate this Geopackage with the QGIS processing tool <code>Package layers</code> accessible with the <strong>Processing / Toolbox</strong> menu.</li>
</ul>
<h2 id="indicators">Indicators</h2>
<h3 id="documents">Documents</h3>
<p>In the G-Obs database, you can add documents to illustrate each indicator. To do so, the table <code>gobs.document</code> must be filled with appropriate data.</p>
<p>An indicator can have different types of documents:</p>
<ul>
<li><code>document</code>: any document such as PDF, ODT, DOC, DOCX, ZIP file</li>
<li><code>icon</code>: the icon of the indicator (a simple and small image file). Must be a jpeg, jpg, png or gif.</li>
<li><code>image</code>: an image file (photo, illustration)</li>
<li><code>other</code>: any other unspecified type of document</li>
<li><code>preview</code>: the image to be shown as the main illustration of the indicator. Must be a jpeg, jpg, png or gif.</li>
<li><code>video</code>: a video file.</li>
<li><code>url</code>: an URL pointing to an external ressource</li>
</ul>
<p>All the document files must be stored in the API server. The document files must stored inside a <code>media/gobsapi/documents/</code> folder, with the <code>media</code> folder located in Lizmap repository root folder. This <code>media</code> folder must be writable. Do it for example with</p>
<pre><code class="bash">chown -R :www-data /srv/data/media
chmod 775 -R /srv/data/media
</code></pre>

<p>For example, if Lizmap Web Client repository root folder is <code>/srv/data/</code>, the root gobsapi media folder will be <code>/srv/data/media/</code> and the documents must be stored in <code>/srv/data/media/gobsapi/documents/INDICATOR_CODE/DOCUMENT_TYPE/DOCUMENT_FILE_NAME.EXT</code>, where</p>
<ul>
<li><code>INDICATOR_CODE</code> is the code of the indicator, for example <code>pluviometry</code></li>
<li><code>DOCUMENT_TYPE</code> is the type of the document, for example <code>image</code></li>
<li><code>DOCUMENT_FILE_NAME.EXT</code> is the name of the file, for example <code>a_picture.jpg</code></li>
</ul>
<p>Two examples:</p>
<ul>
<li><code>/srv/data/media/gobsapi/documents/pluviometry/image/a_picture.jpg</code></li>
<li><code>/srv/data/media/gobsapi/documents/population/document/explaining_demography.pdf</code></li>
</ul>
<p>In the <strong>table</strong> <code>gobs.document</code> of the <strong>G-Obs database</strong> , the path must be stored <strong>relative to the folder</strong> <code>/srv/data/media/gobsapi/documents</code>, and must begin only with the code of the indicator. For example :</p>
<ul>
<li><code>pluviometry/image/a_picture.jpg</code></li>
<li><code>population/document/explaining_demography.pdf</code></li>
</ul>
<p>The API module will then propose an URL to acccess each document, returned when querying the details of an indicator.</p>
<h2 id="observations">Observations</h2>
<h3 id="media">Media</h3>
<p>Each observation can have a photo, called media. When uploading this media file with the API entry point <code>/project/PROJECT_CODE/indicator/INDICATOR_CODE/observation/OBSERVATION_UID/uploadMedia</code>, the media file will be stored in the full path <code>/srv/data/media/gobsapi/observations/OBSERVATION_UID.EXT</code> where:</p>
<ul>
<li><code>INDICATOR_CODE</code> is the code of the indicator, for example <code>pluviometry</code></li>
<li><code>OBSERVATION_UID</code> is the UUID of the osbervation, for example <code>e8f0a46c-1d24-456a-925a-387740ade1c6</code></li>
<li><code>EXT</code> is the extension of the original file sent, for example <code>jpeg</code></li>
</ul>
<p>which can build the example path: <code>/srv/data/media/gobsapi/observations/e8f0a46c-1d24-456a-925a-387740ade1c6.jpeg</code></p>

  </article>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.1/highlight.min.js">
  </script>
  <script>
   hljs.initHighlightingOnLoad();
  </script>
  <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript">
  </script>
  <script type="text/javascript">
   MathJax.Hub.Config({"showProcessingMessages" : false,"messageStyle" : "none","tex2jax": { inlineMath: [ [ "$", "$" ] ] }});
  </script>
 </body>
</html>
